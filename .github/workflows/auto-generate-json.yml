name: Generate Image JSON

on:
  push:
    branches:
      - main
    paths:
      - 'LeviIcons/*'
  workflow_dispatch:
    inputs:
      dummy-trigger:
        description: 'Dummy trigger for manual run'
        default: 'Run workflow'

jobs:
  generate-json:
    runs-on: ubuntu-latest

    steps:
    - name: Set up Node.js
      uses: actions/setup-node@v4.0.0
      with:
        node-version: '16'

    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Display Node.js version
      run: node --version

    - name: Generate JSON
      run: |
        #!/bin/bash

        # 定义图片文件夹路径
        IMAGES_FOLDER="LeviIcons/leviicons"

        # 定义目标 JSON 文件名
        JSON_FILE="levi.icon.json"

        # 创建一个 JSON 文件头部
        echo "{" > $JSON_FILE
        echo '  "name": "Levi图标订阅",' >> $JSON_FILE
        echo '  "description": "收集一些自己常用的图标 by czy13724",' >> $JSON_FILE
        echo '  "icons": [' >> $JSON_FILE

        # 遍历图片文件夹中的所有文件
        FIRST_ITEM=true
        for FILE_PATH in $IMAGES_FOLDER/*; do
          # 忽略非图片文件
          if [ -f "$FILE_PATH" ]; then
            # 获取文件名（即图片名称）
            FILE_NAME=$(basename "$FILE_PATH")

            # 构建 raw 地址
            RAW_URL="https://raw.githubusercontent.com/czy13724/LeviIcons/main/$FILE_PATH"

            # 如果不是第一个图标，则添加逗号
            if [ "$FIRST_ITEM" = true ]; then
              FIRST_ITEM=false
            else
              echo "," >> $JSON_FILE
            fi

            # 将图片信息添加到 JSON 文件
            echo '    {' >> $JSON_FILE
            echo '      "name": "'$FILE_NAME'",' >> $JSON_FILE
            echo '      "url": "'$RAW_URL'"' >> $JSON_FILE
            echo '    }' >> $JSON_FILE
          fi
        done

        # 闭合 JSON 数组
        echo '  ]' >> $JSON_FILE
        echo "}" >> $JSON_FILE

        - name: Set artifact path
        id: set-artifact-path
        run: echo "::set-output name=artifact_path::levi.icon.json"

        # 上传 JSON 文件为 artifact
        echo "Uploading artifact..."
        echo "::set-output name=artifact_path::$GITHUB_WORKSPACE/$JSON_FILE"
        echo "::set-output name=artifact_name::$JSON_FILE"
      env:
        GITHUB_TOKEN: ${{ secrets.LEVIICONSI }}

    - name: Upload Artifact
      uses: actions/upload-artifact@v2
      with:
        name: ${{ needs.generate-json.outputs.artifact_name }}
        path: ${{ needs.generate-json.outputs.artifact_path }}
